<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Список товаров</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .product-image { width: 100px; height: 100px; object-fit: cover; }
        .action-buttons button { margin-right: 5px; }
        .image-preview {
            max-width: 80px; max-height: 80px; margin: 5px;
            border: 1px solid #ddd; padding: 2px; object-fit: cover;
        }
        #image-preview-container-edit { display: flex; flex-wrap: wrap; }
        #existing-images-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #existing-images-container .img-wrapper {
            margin: 5px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 3px;
            background-color: #fff;
            position: relative;
        }
        #existing-images-container .img-wrapper img {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            display: block;
        }
        #existing-images-container .img-wrapper .buttons-container {
            margin-top: 5px;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Наши товары</h1>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
    <div id="success-message" class="alert alert-success" style="display: none;"></div>

    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Фото</th>
            <th>Название</th>
            <th>Артикул</th>
            <th>Цена</th>
            <th>Кол-во</th>
            <th>Категория</th>
            <th>Бренд</th>
            <th>Производитель</th>
            <!-- Добавьте новый столбец в таблицу -->
            <th>Марка авто</th>
            <th>Описание</th>
            <th>В наличии</th>
            <th class="text-center">Действия</th>
        </tr>
        </thead>
        <tbody id="product-table-body"></tbody>
    </table>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Редактировать товар</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" id="edit-productId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-name" class="form-label">Название</label>
                                <input type="text" class="form-control" id="edit-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-articleNumber" class="form-label">Артикул</label>
                                <input type="text" class="form-control" id="edit-articleNumber" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-price" class="form-label">Цена</label>
                                <input type="number" step="0.01" class="form-control" id="edit-price" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-quantity" class="form-label">Количество</label>
                                <input type="number" class="form-control" id="edit-quantity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-brand" class="form-label">Бренд</label>
                                <input type="text" class="form-control" id="edit-brand" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-category" class="form-label">Категория</label>
                                <input type="text" class="form-control" id="edit-category" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-manufacturer" class="form-label">Производитель</label>
                                <input type="text" class="form-control" id="edit-manufacturer">
                            </div>
                            <div class="mb-3">
                                <label for="edit-carBrand" class="form-label">Марка автомобиля</label>
                                <input type="text" class="form-control" id="edit-carBrand">
                            </div>
                            <div class="mb-3">
                                <label for="edit-description" class="form-label">Описание</label>
                                <textarea class="form-control" id="edit-description" rows="2"></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="edit-inStock">
                                <label class="form-check-label" for="edit-inStock">В наличии</label>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5>Существующие фотографии</h5>
                    <div id="existing-images-container" class="mt-2 d-flex flex-wrap"></div>
                    <hr>
                    <div class="mb-3">
                        <label for="edit-files" class="form-label">Добавить новые фото</label>
                        <input type="file" class="form-control" id="edit-files" accept="image/*" multiple>
                        <div id="image-preview-container-edit" class="mt-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchProducts();

        // Обработчик кликов по кнопкам "Редактировать" и "Удалить"
        document.getElementById('product-table-body').addEventListener('click', function(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const productId = target.dataset.id;
            if (target.classList.contains('btn-edit')) {
                handleEdit(productId);
            }
            if (target.classList.contains('btn-delete')) {
                handleDelete(productId);
            }
        });

        // Обработчик сохранения формы редактирования
        document.getElementById('saveChangesBtn').addEventListener('click', submitEditForm);

        // Предпросмотр для новых изображений в модальном окне
        document.getElementById('edit-files').addEventListener('change', previewEditImages);

        // Обработчики для кнопок "Сделать превью" и "Удалить" в модальном окне
        document.getElementById('editProductModal').addEventListener('click', async function(e) {
            const target = e.target;
            const productId = document.getElementById('edit-productId').value; // Получаем ID продукта из скрытого поля

            if (target.classList.contains('set-preview-btn')) {
                const imageId = target.dataset.imageId;
                if (!confirm(`Вы уверены, что хотите сделать это изображение превью?`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/products/${productId}/images/${imageId}/set-preview`, {
                        method: 'PUT'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Не удалось установить изображение как превью.');
                    }

                    showMessage('Превью успешно обновлено!');
                    // Перезагружаем модальное окно, чтобы обновить состояние кнопок
                    handleEdit(productId);
                    // Также обновите основную таблицу, чтобы новое превью отобразилось
                    fetchProducts();
                } catch (error) {
                    console.error('Ошибка при установке превью:', error);
                    showMessage(error.message, 'danger');
                }
            }

            if (target.classList.contains('delete-image-btn')) {
                const imageId = target.dataset.imageId;
                if (!confirm(`Вы уверены, что хотите удалить это изображение?`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/products/${productId}/images/${imageId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Не удалось удалить изображение.');
                    }

                    showMessage('Изображение успешно удалено!');
                    // Обновляем отображение существующих изображений в модальном окне
                    // Удаляем элемент из DOM
                    target.closest('.img-wrapper').remove();
                    // Также обновите основную таблицу, если удалено превью
                    fetchProducts();
                } catch (error) {
                    console.error('Ошибка при удалении изображения:', error);
                    showMessage(error.message, 'danger');
                }
            }
        });
    });

    // Функция для отображения сообщений
    function showMessage(text, type = 'success') {
        const messageEl = document.getElementById(type === 'success' ? 'success-message' : 'error-message');
        messageEl.textContent = text;
        messageEl.style.display = 'block';
        setTimeout(() => { messageEl.style.display = 'none'; }, 4000);
    }

    async function fetchProducts() {
        try {
            const response = await fetch('/api/products/AllProducts');
            if (!response.ok) throw new Error(`Ошибка сети: ${response.statusText}`);

            const products = await response.json();
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                const imageHtml = product.previewImageId
                    ? `<img src="/images/${product.previewImageId}" class="product-image" alt="Фото">`
                    : `<span class="text-muted">Нет фото</span>`;

                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${imageHtml}</td>
                    <td>${product.name}</td>
                    <td>${product.articleNumber}</td>
                    <td>${product.price.toFixed(2)} ₽</td>
                    <td>${product.quantity}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>${product.brand || 'N/A'}</td>
                    <td>${product.manufacturer || 'N/A'}</td>
                    <!-- В строке товара добавьте -->
                    <td>${product.carBrand || 'N/A'}</td>
                    <td>${product.description ? product.description.substring(0, 50) + '...' : 'N/A'}</td>
                    <td>${product.inStock ? '✔️' : '❌'}</td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-primary btn-edit" data-id="${product.id}">✏️</button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="${product.id}">🗑️</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Ошибка:', error);
            showMessage('Ошибка загрузки товаров: ' + error.message, 'danger');
        }
    }

    // ----- ЛОГИКА РЕДАКТИРОВАНИЯ -----
    let editModal;
    async function handleEdit(id) {
        if (!editModal) {
            editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
        }

        try {
            const response = await fetch(`/api/products/${id}`);
            if (!response.ok) throw new Error('Товар не найден');
            const product = await response.json();

            // Заполняем форму
            document.getElementById('edit-productId').value = product.id;
            document.getElementById('edit-name').value = product.name;
            document.getElementById('edit-articleNumber').value = product.articleNumber;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-quantity').value = product.quantity;
            document.getElementById('edit-brand').value = product.brand || '';
            document.getElementById('edit-category').value = product.category || '';
            document.getElementById('edit-manufacturer').value = product.manufacturer || '';
            document.getElementById('edit-carBrand').value = product.carBrand || '';
            document.getElementById('edit-description').value = product.description || '';
            document.getElementById('edit-inStock').checked = product.inStock;

            // Очищаем старые превью для новых файлов и поле для загрузки новых файлов
            document.getElementById('image-preview-container-edit').innerHTML = '';
            document.getElementById('edit-files').value = '';

            // Код для отображения существующих изображений
            const existingImagesContainer = document.getElementById('existing-images-container');
            existingImagesContainer.innerHTML = ''; // Очищаем контейнер перед заполнением

            if (product.images && product.images.length > 0) {
                product.images.forEach(image => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.classList.add('img-wrapper', 'd-flex', 'flex-column', 'align-items-center');
                    imgWrapper.dataset.imageId = image.id; // Для идентификации изображения

                    const img = document.createElement('img');
                    img.src = `/images/${image.id}`; // Используем ImageController для получения изображения
                    img.classList.add('image-preview');
                    img.alt = image.originalFileName;

                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.classList.add('buttons-container');

                    const setPreviewBtn = document.createElement('button');
                    setPreviewBtn.classList.add('btn', 'btn-sm', 'btn-info', 'me-1', 'set-preview-btn');
                    setPreviewBtn.innerHTML = image.isPreviewImage ? '⭐ Превью' : 'Сделать превью';
                    setPreviewBtn.disabled = image.isPreviewImage;
                    setPreviewBtn.dataset.productId = product.id;
                    setPreviewBtn.dataset.imageId = image.id;

                    const deleteImgBtn = document.createElement('button');
                    deleteImgBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'delete-image-btn');
                    deleteImgBtn.innerHTML = '🗑️ Удалить';
                    deleteImgBtn.dataset.productId = product.id;
                    deleteImgBtn.dataset.imageId = image.id;

                    buttonsDiv.appendChild(setPreviewBtn);
                    buttonsDiv.appendChild(deleteImgBtn);

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(buttonsDiv);
                    existingImagesContainer.appendChild(imgWrapper);
                });
            } else {
                existingImagesContainer.innerHTML = '<p class="text-muted">У этого товара нет фотографий.</p>';
            }

            editModal.show();
        } catch (error) {
            showMessage(error.message, 'danger');
        }
    }

    function previewEditImages(event) {
        const previewContainer = document.getElementById('image-preview-container-edit');
        previewContainer.innerHTML = '';
        if (this.files) {
            Array.from(this.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('image-preview');
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    async function submitEditForm() {
        const productId = document.getElementById('edit-productId').value;
        const formData = new FormData();
        const product = {
            name: document.getElementById('edit-name').value,
            articleNumber: document.getElementById('edit-articleNumber').value,
            price: parseFloat(document.getElementById('edit-price').value),
            quantity: parseInt(document.getElementById('edit-quantity').value),
            brand: document.getElementById('edit-brand').value,
            category: document.getElementById('edit-category').value,
            manufacturer: document.getElementById('edit-manufacturer').value,
            carBrand: document.getElementById('edit-carBrand').value,
            description: document.getElementById('edit-description').value,
            inStock: document.getElementById('edit-inStock').checked
        };
        formData.append('product', new Blob([JSON.stringify(product)], { type: "application/json" }));

        const fileInput = document.getElementById('edit-files');
        if (fileInput.files.length > 0) {
            for (const file of fileInput.files) {
                formData.append('files', file);
            }
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                body: formData
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Ошибка при обновлении товара.');
            }

            editModal.hide();
            showMessage('Товар успешно обновлен!');
            fetchProducts(); // Обновляем таблицу
        } catch (error) {
            showMessage(error.message, 'danger');
        }
    }

    // ----- ЛОГИКА УДАЛЕНИЯ -----
    async function handleDelete(id) {
        if (!confirm(`Вы уверены, что хотите удалить товар с ID ${id}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/products/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Не удалось удалить товар.');
            }

            showMessage(`Товар с ID ${id} успешно удален.`);
            fetchProducts(); // Обновляем таблицу

        } catch (error) {
            console.error('Ошибка удаления:', error);
            showMessage(error.message, 'danger');
        }
    }
</script>
</body>
</html>