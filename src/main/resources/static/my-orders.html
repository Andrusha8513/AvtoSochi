<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мои заказы</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">AutoSochi</a>
        <a href="/catalog.html" class="btn btn-outline-light">Вернуться в каталог</a>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="mb-4">Мои заказы</h1>
    <div id="orders-container"></div>
</div>

<script>
    const statusOptions = {
        "PLACED": "Оформлен",
        "IN_TRANSIT": "В пути",
        "AT_PICKUP_POINT": "В пункте выдачи",
        "DELIVERED": "Товар у покупателя",
        "RETURN_REQUESTED": "Оформлен возврат",
        "RETURN_COMPLETED": "Возврат выполнен"
    };

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/orders/my-orders');
            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                throw new Error('Ошибка загрузки заказов');
            }
            const orders = await response.json();
            renderMyOrders(orders);
        } catch (error) {
            document.getElementById('orders-container').innerHTML = '<p class="text-danger">Не удалось загрузить ваши заказы.</p>';
        }
    });

    function canCancelOrder(order) {
        const allowedStatuses = ['PLACED', 'IN_TRANSIT'];
        const orderDate = new Date(order.orderDate);
        const daysDiff = Math.floor((new Date() - orderDate) / (1000 * 60 * 60 * 24));
        return allowedStatuses.includes(order.status) && daysDiff <= 14;
    }

    function canReturnOrder(order) {
        const allowedStatuses = ['AT_PICKUP_POINT', 'DELIVERED'];
        const orderDate = new Date(order.orderDate);
        const daysDiff = Math.floor((new Date() - orderDate) / (1000 * 60 * 60 * 24));

        if (order.status === 'DELIVERED') {
            return daysDiff <= 14;
        }
        return allowedStatuses.includes(order.status);
    }

    function renderMyOrders(orders) {
        const container = document.getElementById('orders-container');
        container.innerHTML = '';

        if (!orders || orders.length === 0) {
            container.innerHTML = '<p>У вас еще нет заказов.</p>';
            return;
        }

        orders.forEach(order => {
            const itemsHtml = order.items.map(item => `
                <li class="list-group-item d-flex justify-content-between">
                    <span>${item.product.name}</span>
                    <span>${item.quantity} шт. x ${item.priceAtPurchase.toFixed(2)} ₽</span>
                </li>
            `).join('');

            const cancelButton = canCancelOrder(order)
                ? `<button class="btn btn-warning btn-sm me-2" onclick="cancelOrder(${order.id})">Отменить заказ</button>`
                : '';

            const returnButton = canReturnOrder(order)
                ? `<button class="btn btn-info btn-sm" onclick="returnOrder(${order.id})">Вернуть товар</button>`
                : '';

            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.innerHTML = `
                <div class="card-header d-flex justify-content-between">
                    <span>Заказ №${order.id} от ${new Date(order.orderDate).toLocaleDateString()}</span>
                    <strong>Статус: ${statusOptions[order.status]}</strong>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        ${itemsHtml}
                    </ul>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <strong>Итого: ${order.totalPrice.toFixed(2)} ₽</strong>
                    <div>
                        ${cancelButton}
                        ${returnButton}
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function cancelOrder(orderId) {
        if (!confirm('Вы уверены, что хотите отменить этот заказ?')) return;

        try {
            const response = await fetch(`/api/orders/${orderId}/cancel`, {
                method: 'PUT'
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }

            alert('Запрос на отмену отправлен!');
            loadOrders(); // Перезагружаем список заказов
        } catch (error) {
            alert('Ошибка: ' + error.message);
        }
    }

    async function returnOrder(orderId) {
        if (!confirm('Вы уверены, что хотите вернуть этот товар?')) return;

        try {
            const response = await fetch(`/api/orders/${orderId}/return`, {
                method: 'PUT'
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }

            alert('Запрос на возврат отправлен!');
            loadOrders(); // Перезагружаем список заказов
        } catch (error) {
            alert('Ошибка: ' + error.message);
        }
    }

    // Функция для загрузки заказов
    async function loadOrders() {
        try {
            const response = await fetch('/api/orders/my-orders');
            if (response.ok) {
                const orders = await response.json();
                renderMyOrders(orders);
            }
        } catch (error) {
            console.error('Error loading orders:', error);
        }
    }
</script>
</body>
</html>