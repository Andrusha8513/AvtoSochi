<!DOCTYPE html>
<html>
<head>
    <title>Forgot Password</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        .message { color: green; display: none; margin-top: 10px; }
        .error { color: red; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Forgot Password</h2>
    <div id="statusMessage" class="message"></div>
    <div id="errorMessage" class="error"></div>

    <div id="requestForm">
        <p>Enter your email to receive a password reset code.</p>
        <input type="text" id="email" placeholder="Email" required>
        <button onclick="requestPasswordReset()">Send Code</button>
    </div>

    <div id="resetForm" style="display: none;">
        <p>A code has been sent to your email. Enter the code and your new password below.</p>
        <input type="text" id="resetEmail" placeholder="Email" required disabled>
        <input type="text" id="code" placeholder="Verification Code" required>
        <input type="password" id="newPassword" placeholder="New Password" required>
        <button onclick="resetPasswordWithCode()">Reset Password</button>
    </div>
</div>

<script>
    async function requestPasswordReset() {
        const email = document.getElementById('email').value;
        if (!email) {
            alert('Please enter your email.');
            return;
        }

        try {
            const response = await fetch('/api/users/password/request-reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            const message = await response.text();

            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusMessage').style.display = 'block';

            // После успешной отправки запроса, показываем вторую форму
            document.getElementById('requestForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'block';
            document.getElementById('resetEmail').value = email;

        } catch (error) {
            document.getElementById('errorMessage').textContent = 'Error sending request.';
            document.getElementById('errorMessage').style.display = 'block';
        }
    }

    async function resetPasswordWithCode() {
        const email = document.getElementById('resetEmail').value;
        const code = document.getElementById('code').value;
        const newPassword = document.getElementById('newPassword').value;

        if (!email || !code || !newPassword) {
            alert('Please fill in all fields.');
            return;
        }

        try {
            const response = await fetch('/api/users/password/reset-confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: code, newPassword: newPassword })
            });

            const message = await response.text();

            if (response.ok) {
                document.getElementById('statusMessage').textContent = message + ' Redirecting to login...';
                document.getElementById('statusMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            } else {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('statusMessage').style.display = 'none';
            }

        } catch (error) {
            document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('statusMessage').style.display = 'none';
        }
    }
</script>
</body>
</html>